<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KOTAai Inventory Dashboard | Kota King Klerksdorp</title>
    <style>
        :root {
            --high-urgency: #ff6b6b;
            --medium-urgency: #ffa502;
            --low-urgency: #4caf50;
            --critical-bg: #fff5f5;
            --warning-bg: #fff8e6;
            --ok-bg: #f6fff6;
            --border: #e2e8f0;
            --header-bg: #1a365d;
            --card-bg: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e6f7ff 100%);
            color: var(--text-primary);
            line-height: 1.5;
            padding: 10px;
            min-height: 100vh;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        header {
            background: var(--header-bg);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .logo-section h1 {
            font-size: 1.5rem;
            background: linear-gradient(to right, #ffd700, #ffaa00);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .logo-section p { font-size: 0.8rem; opacity: 0.8; }
        
        .status-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        .status-dot { width: 8px; height: 8px; background: var(--low-urgency); border-radius: 50%; }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .summary-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-top: 3px solid var(--low-urgency);
        }
        
        .summary-card.critical { border-top-color: var(--high-urgency); }
        .summary-card.warning { border-top-color: var(--medium-urgency); }
        
        .summary-card h3 { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px; }
        .summary-value { font-size: 1.4rem; font-weight: 800; color: var(--header-bg); }

        .dashboard-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            color: white;
            background: var(--header-bg);
        }

        .btn.auto-refresh.active { background: var(--high-urgency); }

        /* RESPONSIVE TABLE */
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; text-align: left; padding: 12px; font-size: 0.8rem; color: var(--text-secondary); border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }

        @media (max-width: 768px) {
            thead { display: none; }
            tr {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                padding: 15px;
                margin-bottom: 12px;
                border: 1px solid var(--border);
                border-radius: 10px;
                background: #fff;
                border-left: 5px solid #ccc;
            }
            tr.critical-row { border-left-color: var(--high-urgency); background: var(--critical-bg); }
            tr.warning-row { border-left-color: var(--medium-urgency); background: var(--warning-bg); }
            tr.ok-row { border-left-color: var(--low-urgency); background: var(--ok-bg); }

            td { display: flex; flex-direction: column; padding: 0 !important; border: none; }
            td::before {
                content: attr(data-label);
                font-size: 0.7rem;
                text-transform: uppercase;
                font-weight: 700;
                color: var(--text-secondary);
                margin-bottom: 2px;
            }
            td:first-child {
                grid-column: span 2;
                font-weight: 800;
                font-size: 1.1rem;
                margin-bottom: 8px;
                border-bottom: 1px solid rgba(0,0,0,0.05);
                padding-bottom: 8px !important;
            }
            td:first-child::before { display: none; }
        }

        .urgency-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .urgency-critical { background: var(--high-urgency); color: white; }
        .urgency-warning { background: var(--medium-urgency); color: white; }
        .urgency-ok { background: var(--low-urgency); color: white; }

        .loading, .error { text-align: center; padding: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-section">
                    <h1>üçõ KOTAai DASHBOARD</h1>
                    <p>Kota King Klerksdorp Inventory</p>
                </div>
                <div class="status-bar">
                    <span class="status-dot"></span>
                    <span>System Live</span>
                </div>
            </div>
        </header>

        <div class="summary-grid">
            <div class="summary-card">
                <h3>Total Items</h3>
                <div class="summary-value" id="total-items">-</div>
            </div>
            <div class="summary-card critical" id="critical-card">
                <h3>Critical</h3>
                <div class="summary-value" id="critical-items">-</div>
            </div>
            <div class="summary-card warning">
                <h3>To Order</h3>
                <div class="summary-value" id="total-recommended">-</div>
            </div>
        </div>

        <div class="dashboard-section">
            <div class="section-header">
                <h2 style="font-size: 1.1rem;">Reorder List</h2>
                <div style="display: flex; gap: 5px;">
                    <button class="btn" id="refresh-btn">üîÑ Refresh</button>
                    <button class="btn auto-refresh" id="auto-refresh-btn">‚è∞ Auto</button>
                </div>
            </div>

            <div id="loading" class="loading">Fetching data...</div>
            <div id="error-container" class="error" style="display:none; color: red;"></div>

            <div id="recommendations-container" style="display:none;">
                <table>
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Stock</th>
                            <th>Demand</th>
                            <th>Days</th>
                            <th>Order</th>
                            <th>Urgency</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            API_URL: 'https://restaurant-demand-forecasting-1.onrender.com/api/dashboard',
            AUTO_REFRESH_INTERVAL: 300000,
            ITEMS: ["Flamwood", "Stop 5", "Stop 18", "Phelandaba", "Steak", "Toast"]
        };

        const elements = {
            loading: document.getElementById('loading'),
            container: document.getElementById('recommendations-container'),
            tableBody: document.getElementById('table-body'),
            totalItems: document.getElementById('total-items'),
            criticalItems: document.getElementById('critical-items'),
            totalRecommended: document.getElementById('total-recommended'),
            refreshBtn: document.getElementById('refresh-btn'),
            autoBtn: document.getElementById('auto-refresh-btn'),
            error: document.getElementById('error-container')
        };

        let autoRefreshInterval;

        async function loadData() {
            elements.loading.style.display = 'block';
            elements.container.style.display = 'none';
            elements.error.style.display = 'none';

            // RESTORED ORIGINAL PAYLOAD FORMAT
            const payload = {
                items: CONFIG.ITEMS.map(item => ({ item_name: item }))
            };

            try {
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                render(data.recommendations);
            } catch (err) {
                console.error(err);
                elements.loading.style.display = 'none';
                elements.error.innerText = "Connection failed. Please check your internet or API status.";
                elements.error.style.display = 'block';
            }
        }

        function render(items) {
            elements.loading.style.display = 'none';
            elements.container.style.display = 'block';
            elements.tableBody.innerHTML = '';
            
            let criticals = 0;
            let totalOrder = 0;

            items.forEach(item => {
                const days = parseInt(item.days_left);
                const urgency = days <= 1 ? 'critical' : (days <= 3 ? 'warning' : 'ok');
                if (urgency === 'critical') criticals++;
                totalOrder += item.recommended_order;

                const tr = document.createElement('tr');
                tr.className = `${urgency}-row`;
                // Added data-label attributes for mobile cards
                tr.innerHTML = `
                    <td data-label="Item">${item.item_name}</td>
                    <td data-label="Stock">${item.current_stock}</td>
                    <td data-label="Weekly Demand">${item.weekly_demand}</td>
                    <td data-label="Days Left">${item.days_left}d</td>
                    <td data-label="Order">${item.recommended_order}</td>
                    <td data-label="Urgency"><span class="urgency-badge urgency-${urgency}">${urgency.toUpperCase()}</span></td>
                `;
                elements.tableBody.appendChild(tr);
            });

            elements.totalItems.innerText = items.length;
            elements.criticalItems.innerText = criticals;
            elements.totalRecommended.innerText = totalOrder;
        }

        elements.refreshBtn.onclick = loadData;
        
        elements.autoBtn.onclick = () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                elements.autoBtn.classList.remove('active');
                elements.autoBtn.innerText = "‚è∞ Auto";
            } else {
                autoRefreshInterval = setInterval(loadData, CONFIG.AUTO_REFRESH_INTERVAL);
                elements.autoBtn.classList.add('active');
                elements.autoBtn.innerText = "‚è∞ Live";
                loadData();
            }
        };

        // Initial Load
        loadData();
    </script>
</body>
</html>
