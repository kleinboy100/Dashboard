<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOTAai Inventory Dashboard | Kota King Klerksdorp</title>
    <style>
        :root {
            --high-urgency: #ff6b6b;
            --medium-urgency: #ffa502;
            --low-urgency: #4caf50;
            --critical-bg: #fff5f5;
            --warning-bg: #fff8e6;
            --ok-bg: #f6fff6;
            --border: #e2e8f0;
            --header-bg: #1a365d;
            --card-bg: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --brand-blue: #3182ce;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e6f7ff 100%);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: var(--header-bg);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        .header-content {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo-section h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(to right, #ffd700, #ffaa00);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 5px;
        }
        
        .logo-section p {
            color: rgba(255, 255, 255, 0.85);
            font-size: 1.1rem;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 22px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            border-top: 4px solid var(--low-urgency);
        }
        
        .summary-card.critical { border-top-color: var(--high-urgency); }
        .summary-card.warning { border-top-color: var(--medium-urgency); }
        
        .summary-card h3 {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        
        .summary-value {
            font-size: 2.2rem;
            font-weight: 800;
            margin: 8px 0;
            color: var(--header-bg);
        }

        .summary-card.critical .summary-value { color: var(--high-urgency); }
        .summary-card.warning .summary-value { color: var(--medium-urgency); }

        .dashboard-section {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }
        
        .section-header h2 {
            font-size: 1.6rem;
            color: var(--header-bg);
        }
        
        /* Filter Section Styles */
        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .filter-controls input, .filter-controls select {
            padding: 10px 15px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            background: white;
        }

        .history-result-box {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background: var(--ok-bg);
            border-left: 4px solid var(--brand-blue);
            font-size: 1.1rem;
            display: none;
        }

        .btn {
            background: linear-gradient(to right, var(--header-bg), #2c5282);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn.refresh { background: linear-gradient(to right, #2b6cb0, #3182ce); }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th {
            background: var(--header-bg);
            color: white;
            text-align: left;
            padding: 16px 20px;
        }
        
        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        tr:hover td { background: #f8fafc; }
        .urgency-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .urgency-high { background: rgba(255, 107, 107, 0.15); color: var(--high-urgency); border: 1px solid var(--high-urgency); }
        .urgency-medium { background: rgba(255, 165, 2, 0.15); color: var(--medium-urgency); border: 1px solid var(--medium-urgency); }
        .urgency-low { background: rgba(76, 175, 80, 0.15); color: var(--low-urgency); border: 1px solid var(--low-urgency); }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .daily-usage-highlight {
            font-weight: bold;
            color: #d32f2f;
            background: #fff0f0;
            border-radius: 6px;
            padding: 4px 8px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-section">
                    <h1>üçõ KOTAai DASHBOARD</h1>
                    <p>Intelligent Inventory Management ‚Ä¢ Kota King Klerksdorp</p>
                </div>
            </div>
        </header>
        
        <div class="summary-grid">
            <div class="summary-card" id="total-items-card">
                <h3>üì¶ Total Items Monitored</h3>
                <div class="summary-value" id="total-items">-</div>
            </div>
            <div class="summary-card critical" id="critical-items-card">
                <h3>üö® Critical Items</h3>
                <div class="summary-value" id="critical-items">-</div>
            </div>
            <div class="summary-card warning" id="recommended-order-card">
                <h3>üõí Total Recommended Order</h3>
                <div class="summary-value" id="total-recommended">-</div>
            </div>
            <div class="summary-card" id="last-update-card">
                <h3>‚è±Ô∏è Last Updated</h3>
                <div class="summary-value" id="last-update" style="font-size:1.5rem;">-</div>
            </div>
        </div>

        <!-- NEW HISTORICAL USAGE CARD -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2>üìÖ Historical Ingredient Usage Analyzer</h2>
            </div>
            <div class="filter-controls">
                <input type="date" id="history-date">
                <select id="history-ingredient">
                    <option value="All">All Ingredients</option>
                </select>
                <button class="btn refresh" id="check-history-btn">Check Past Usage</button>
            </div>
            <div id="history-result" class="history-result-box">
                <!-- Javascript will populate this -->
            </div>
        </div>
        
        <div class="dashboard-section">
            <div class="section-header">
                <h2>üìã Live Reorder & Forecast</h2>
                <button class="btn refresh" id="refresh-btn">üîÑ Refresh Now</button>
            </div>
            
            <div id="loading" class="loading">Loading AI recommendations & live usage...</div>
            
            <div id="recommendations-container" style="display:none;">
                <table id="recommendations-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Current Stock</th>
                            <th>Used Today (SAST)</th> <!-- NEW COLUMN ADDED HERE -->
                            <th>Weekly Demand</th>
                            <th>Days Left</th>
                            <th>Rec. Order</th>
                            <th>Urgency</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ======================
        // CONFIGURATION
        // ======================
        const CONFIG = {
            // Your base API URL
            API_BASE: 'https://restaurant-demand-forecasting-1.onrender.com', 
            
            // Fixed smart quotes in your array
            ITEMS_TO_MONITOR: ["Russian", "Bread", "Lettuce", "Melted Cheese", "Steak", "Atchar", "Vienna", "Tomato", "Burger"]
        };
        
        const elements = {
            loading: document.getElementById('loading'),
            recommendationsContainer: document.getElementById('recommendations-container'),
            tableBody: document.getElementById('table-body'),
            refreshBtn: document.getElementById('refresh-btn'),
            totalItems: document.getElementById('total-items'),
            criticalItems: document.getElementById('critical-items'),
            totalRecommended: document.getElementById('total-recommended'),
            lastUpdate: document.getElementById('last-update'),
            historyDate: document.getElementById('history-date'),
            historyIngredient: document.getElementById('history-ingredient'),
            checkHistoryBtn: document.getElementById('check-history-btn'),
            historyResultBox: document.getElementById('history-result')
        };
        
        // Populate the ingredient dropdown dynamically
        CONFIG.ITEMS_TO_MONITOR.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.textContent = item;
            elements.historyIngredient.appendChild(opt);
        });

        // Set Date Picker default to today SAST
        const today = new Date().toISOString().split('T')[0];
        elements.historyDate.value = today;

        // ======================
        // DASHBOARD FETCH
        // ======================
        async function fetchRecommendations() {
            elements.loading.style.display = "block";
            elements.recommendationsContainer.style.display = "none";
            
            try {
                const response = await fetch(`${CONFIG.API_BASE}/api/dashboard`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        items: CONFIG.ITEMS_TO_MONITOR.map(item => ({ item_name: item }))
                    })
                });

                const data = await response.json();
                
                elements.totalItems.textContent = data.summary.total_items;
                elements.criticalItems.textContent = data.summary.critical_items;
                elements.totalRecommended.textContent = data.summary.total_recommended;
                elements.lastUpdate.textContent = data.summary.timestamp.split(' ')[1]; // Just time

                elements.tableBody.innerHTML = "";

                data.items.forEach(item => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td><strong>${item.item_name}</strong></td>
                        <td>${item.current_stock}</td>
                        <td><span class="daily-usage-highlight">${item.daily_usage} units</span></td>
                        <td>${item.weekly_demand}</td>
                        <td>${item.days_left}</td>
                        <td><strong>${item.recommended_order}</strong></td>
                        <td><span class="urgency-badge urgency-${item.urgency.toLowerCase()}">${item.urgency}</span></td>
                        <td style="font-weight:bold;">${item.status}</td>
                        <td>${item.action}</td>
                    `;
                    elements.tableBody.appendChild(row);
                });

                elements.recommendationsContainer.style.display = "block";
                elements.loading.style.display = "none";
            } catch (error) {
                console.error("Fetch error:", error);
                elements.loading.innerHTML = `<span style="color:red">Error loading data. Check console.</span>`;
            }
        }

        // ======================
        // HISTORICAL USAGE FETCH
        // ======================
        async function fetchHistoricalUsage() {
            const dateVal = elements.historyDate.value;
            const ingredientVal = elements.historyIngredient.value;

            elements.historyResultBox.style.display = "block";
            elements.historyResultBox.innerHTML = `‚è≥ Analyzing past orders for ${dateVal}...`;

            try {
                const response = await fetch(`${CONFIG.API_BASE}/api/usage-history`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_date: dateVal,
                        ingredient_name: ingredientVal
                    })
                });

                const data = await response.json();

                if (ingredientVal === "All") {
                    let resultHtml = `<strong>üìä Total Usage on ${dateVal}:</strong><br><ul style="margin-top:10px; margin-left:20px;">`;
                    for (const [ing, amount] of Object.entries(data.all_data)) {
                        resultHtml += `<li><strong>${ing.toUpperCase()}</strong>: ${amount} units</li>`;
                    }
                    if(Object.keys(data.all_data).length === 0) resultHtml += `<li>No ingredients used on this day.</li>`;
                    resultHtml += `</ul>`;
                    elements.historyResultBox.innerHTML = resultHtml;
                } else {
                    elements.historyResultBox.innerHTML = `
                        <strong>‚úÖ Result:</strong> On <strong>${dateVal}</strong>, 
                        <span style="color:#d32f2f; font-weight:bold;">${data.amount_used} units</span> 
                        of <strong>${ingredientVal}</strong> were used.
                    `;
                }

            } catch (error) {
                elements.historyResultBox.innerHTML = `<span style="color:red">Failed to fetch historical data.</span>`;
            }
        }

        // ======================
        // EVENT LISTENERS
        // ======================
        elements.refreshBtn.addEventListener("click", fetchRecommendations);
        elements.checkHistoryBtn.addEventListener("click", fetchHistoricalUsage);

        // Run immediately on load
        fetchRecommendations();
    </script>
</body>
  </html>
