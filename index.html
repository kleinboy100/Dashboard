<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOTAai Ingredient Intelligence | Kota King Klerksdorp</title>
    <style>
        :root {
            --high: #ff6b6b; --medium: #ffa502; --low: #4caf50;
            --critical-bg: #fff5f5; --warning-bg: #fff8e6; --ok-bg: #f6fff6;
            --border: #e2e8f0; --header: #1a365d; --card: #ffffff;
            --text: #1a202c; --secondary: #4a5568; --brand: #3182ce;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e6f7ff 100%);
            color: var(--text);
            line-height: 1.5;
            padding: 15px;
            min-height: 100vh;
        }
        .container { max-width: 1300px; margin: 0 auto; }
        header {
            background: var(--header);
            color: white;
            padding: 1.4rem;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            text-align: center;
        }
        header h1 {
            font-size: 2.1rem;
            background: linear-gradient(to right, #ffd700, #ffaa00);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 8px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin-bottom: 25px;
        }
        .summary-card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.07);
            border-top: 4px solid var(--low);
            transition: transform 0.2s;
        }
        .summary-card:hover { transform: translateY(-3px); }
        .summary-card.critical { border-top-color: var(--high); }
        .summary-card.warning { border-top-color: var(--medium); }
        .summary-card h3 {
            font-size: 1.05rem;
            color: var(--secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .summary-value {
            font-size: 2.0rem;
            font-weight: 800;
            color: var(--header);
        }
        .summary-card.critical .summary-value { color: var(--high); }
        .summary-card.warning .summary-value { color: var(--medium); }
        
        .dashboard-section {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.07);
            padding: 22px;
            margin-bottom: 25px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 15px;
        }
        .section-header h2 {
            font-size: 1.55rem;
            color: var(--header);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            background: #f8fafc;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            margin-top: 10px;
        }
        .filter-controls input, .filter-controls select {
            padding: 9px 14px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
        }
        .btn {
            background: linear-gradient(to right, var(--header), #2c5282);
            color: white;
            border: none;
            padding: 9px 18px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        .btn:hover { transform: translateY(-1px); opacity: 0.95; }
        .btn.refresh { background: linear-gradient(to right, #2b6cb0, var(--brand)); }
        
        .table-container {
            width: 100%;
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-top: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px; /* Prevent cramped columns */
        }
        th {
            background: var(--header);
            color: white;
            text-align: left;
            padding: 14px 16px;
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 500;
        }
        tr:hover td { background-color: #f9fbfd; }
        tr.critical-row { background-color: var(--critical-bg) !important; border-left: 3px solid var(--high); }
        tr.warning-row { background-color: var(--warning-bg) !important; border-left: 3px solid var(--medium); }
        tr.ok-row { background-color: var(--ok-bg) !important; border-left: 3px solid var(--low); }
        
        .urgency-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            min-width: 75px;
            text-align: center;
        }
        .urgency-high { background: rgba(255,107,107,0.12); color: var(--high); border: 1px solid var(--high); }
        .urgency-medium { background: rgba(255,165,2,0.12); color: var(--medium); border: 1px solid var(--medium); }
        .urgency-low { background: rgba(76,175,80,0.12); color: var(--low); border: 1px solid var(--low); }
        
        .daily-usage {
            font-weight: 700;
            color: #c53030;
            background: #fff5f5;
            padding: 3px 8px;
            border-radius: 6px;
            display: inline-block;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: var(--secondary);
            font-size: 1.1rem;
        }
        .spinner {
            border: 3px solid rgba(26,54,93,0.1);
            border-top: 3px solid var(--header);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .footer {
            text-align: center;
            padding: 22px 15px;
            color: var(--secondary);
            font-size: 0.92rem;
            margin-top: 15px;
            border-top: 1px solid var(--border);
            line-height: 1.5;
        }
        .footer p { margin: 4px 0; }
        .debug-toggle {
            background: #e2e8f0;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 10px;
        }
        .debug-box {
            margin-top: 15px;
            padding: 12px;
            background: #edf2f7;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
            .section-header { flex-direction: column; align-items: flex-start; }
            .filter-controls { flex-direction: column; align-items: stretch; }
            th, td { padding: 10px 12px; font-size: 0.9rem; }
            .summary-value { font-size: 1.7rem; }
        }
        @media (max-width: 480px) {
            .summary-grid { grid-template-columns: 1fr; }
            header h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçõ KOTAai INGREDIENT INTELLIGENCE</h1>
            <p style="color: rgba(255,255,255,0.85); font-size: 1.05rem;">Real-Time Stock Monitoring ‚Ä¢ Kota King Klerksdorp</p>
        </header>
        
        <div class="summary-grid">
            <div class="summary-card">
                <h3>üì¶ Ingredients Tracked</h3>
                <div class="summary-value" id="total-items">-</div>
            </div>
            <div class="summary-card critical">
                <h3>üö® Critical Stock</h3>
                <div class="summary-value" id="critical-items">-</div>
            </div>
            <div class="summary-card warning">
                <h3>üõí Recommended Order</h3>
                <div class="summary-value" id="total-recommended">-</div>
            </div>
            <div class="summary-card">
                <h3>‚è±Ô∏è Last Updated</h3>
                <div class="summary-value" id="last-update" style="font-size:1.6rem;">-</div>
            </div>
        </div>

        <!-- HISTORICAL USAGE SECTION -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2>üìÖ Historical Ingredient Usage</h2>
            </div>
            <div class="filter-controls">
                <input type="date" id="history-date">
                <select id="history-ingredient">
                    <option value="">Select Ingredient</option>
                    <!-- Populated by JS -->
                </select>
                <button class="btn refresh" id="check-history-btn">üîç Check Usage</button>
                <button class="debug-toggle" id="debug-toggle">Show Debug Info</button>
            </div>
            <div id="history-result" class="loading" style="padding:15px; margin-top:10px; display:none;">
                <div class="spinner"></div>
                <div>Calculating historical usage...</div>
            </div>
            <div id="debug-box" class="debug-box"></div>
        </div>
        
        <!-- MAIN INGREDIENT DASHBOARD -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2>üìã Live Ingredient Inventory</h2>
                <button class="btn refresh" id="refresh-btn">üîÑ Refresh Data</button>
            </div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <div>Loading ingredient intelligence...</div>
            </div>
            <div id="recommendations-container" style="display:none;">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Ingredient</th>
                                <th>Current Stock</th>
                                <th>Used Today (SAST)</th>
                                <th>Est. Weekly Demand</th>
                                <th>Days Left</th>
                                <th>Reorder Qty</th>
                                <th>Urgency</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- FOOTER (RESTORED) -->
        <div class="footer">
            <p><strong>KOTAai Ingredient Intelligence System</strong> ‚Ä¢ Proprietary Forecasting Technology ‚Ä¢ ¬© 2026 Kota King Klerksdorp</p>
            <p>System Version: 3.0 ‚Ä¢ Data Source: KOTAai API ‚Ä¢ Forecast Method: Meal-to-Ingredient Conversion ‚Ä¢ SAST Timezone</p>
            <p style="margin-top:6px; font-size:0.85rem; color:#718096;">All ingredient usage calculations reset precisely at 00:00 SAST daily. Historical data derived from order_items + meal_recipes.</p>
        </div>
    </div>

    <script>
        const CONFIG = {
            API_BASE: 'https://restaurant-demand-forecasting-1.onrender.com',
            INGREDIENTS: [
                "Chips", "Melted Cheese", "Russian", "Lettuce", "Bread", 
                "Tomato", "Atchar", "Vienna", "Egg", "Steak"
            ]
        };
        
        const els = {
            loading: document.getElementById('loading'),
            container: document.getElementById('recommendations-container'),
            tableBody: document.getElementById('table-body'),
            refreshBtn: document.getElementById('refresh-btn'),
            totalItems: document.getElementById('total-items'),
            criticalItems: document.getElementById('critical-items'),
            totalRecommended: document.getElementById('total-recommended'),
            lastUpdate: document.getElementById('last-update'),
            historyDate: document.getElementById('history-date'),
            historyIngredient: document.getElementById('history-ingredient'),
            checkBtn: document.getElementById('check-history-btn'),
            resultBox: document.getElementById('history-result'),
            debugBox: document.getElementById('debug-box'),
            debugToggle: document.getElementById('debug-toggle')
        };
        
        // Populate ingredient dropdown
        CONFIG.INGREDIENTS.forEach(ing => {
            const opt = document.createElement('option');
            opt.value = ing;
            opt.textContent = ing;
            els.historyIngredient.appendChild(opt);
        });
        
        // Set date to today
        const today = new Date().toISOString().split('T')[0];
        els.historyDate.value = today;
        
        // Toggle debug box
        els.debugToggle.addEventListener('click', () => {
            els.debugBox.style.display = els.debugBox.style.display === 'block' ? 'none' : 'block';
            els.debugToggle.textContent = els.debugBox.style.display === 'block' ? 'Hide Debug Info' : 'Show Debug Info';
        });
        
        // Fetch live dashboard data
        async function fetchDashboard() {
            els.loading.style.display = 'block';
            els.container.style.display = 'none';
            
            try {
                const response = await fetch(`${CONFIG.API_BASE}/api/dashboard`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        items: CONFIG.INGREDIENTS.map(ing => ({ item_name: ing }))
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                // Update summary cards
                els.totalItems.textContent = data.summary.total_items;
                els.criticalItems.textContent = data.summary.critical_items;
                els.totalRecommended.textContent = data.summary.total_recommended;
                els.lastUpdate.textContent = data.summary.timestamp.split(' ')[1];
                
                // Populate table
                els.tableBody.innerHTML = '';
                data.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = `${item.status.toLowerCase()}-row`;
                    row.innerHTML = `
                        <td><strong>${item.item_name}</strong></td>
                        <td>${item.current_stock}</td>
                        <td><span class="daily-usage">${item.daily_usage}</span></td>
                        <td>${item.weekly_demand}</td>
                        <td>${item.days_left}</td>
                        <td><strong>${item.recommended_order}</strong></td>
                        <td><span class="urgency-badge urgency-${item.urgency.toLowerCase()}">${item.urgency}</span></td>
                        <td><strong>${item.status}</strong></td>
                        <td>${item.action}</td>
                    `;
                    els.tableBody.appendChild(row);
                });
                
                els.container.style.display = 'block';
                els.loading.style.display = 'none';
            } catch (err) {
                console.error('Dashboard fetch failed:', err);
                els.loading.innerHTML = `<span style="color:#e53e3e">‚ùå Error: ${err.message}</span>`;
            }
        }
        
        // Fetch historical usage
        async function fetchHistory() {
            const date = els.historyDate.value;
            const ing = els.historyIngredient.value;
            if (!ing) {
                alert('Please select an ingredient');
                return;
            }
            
            els.resultBox.style.display = 'block';
            els.resultBox.innerHTML = `<div class="spinner"></div><div>Checking ${ing} usage for ${date}...</div>`;
            els.debugBox.style.display = 'none';
            
            try {
                const response = await fetch(`${CONFIG.API_BASE}/api/usage-history`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target_date: date, ingredient_name: ing })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                // Show result
                els.resultBox.innerHTML = `
                    <div style="padding:12px; background:${data.amount_used > 0 ? '#f0fff4' : '#fff0f0'}; border-radius:8px; border-left:3px solid ${data.amount_used > 0 ? '#38a169' : '#e53e3e'};">
                        <strong>${ing}</strong> used on <strong>${date}</strong>: 
                        <span style="font-size:1.4rem; font-weight:700; color:${data.amount_used > 0 ? '#2f855a' : '#c53030'}">
                            ${data.amount_used} ${data.unit}
                        </span>
                    </div>
                `;
                
                // Populate debug info (hidden by default)
                els.debugBox.innerHTML = `
                    <strong>üîç Calculation Details:</strong><br>
                    ‚Ä¢ Date queried (SAST): ${date}<br>
                    ‚Ä¢ Ingredient: ${ing}<br>
                    ‚Ä¢ Raw value: ${data.amount_used} ${data.unit}<br>
                    ‚Ä¢ Source: Aggregated from all meals containing this ingredient<br>
                    ‚Ä¢ Reset time: Daily at 00:00 SAST
                `;
            } catch (err) {
                console.error('History fetch failed:', err);
                els.resultBox.innerHTML = `<span style="color:#e53e3e">‚ùå Error: ${err.message}</span>`;
                els.debugBox.innerHTML = `<span style="color:#dd6b20">Debug: ${err.toString()}</span>`;
            }
        }
        
        // Event listeners
        els.refreshBtn.addEventListener('click', fetchDashboard);
        els.checkBtn.addEventListener('click', fetchHistory);
        
        // Initialize
        fetchDashboard();
        
        // Auto-refresh every 5 minutes
        setInterval(fetchDashboard, 300000);
    </script>
</body>
</html>
